@page "/change-password"
@using AuthManagement.Services
@using AuthManagement.Models
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Headers
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@attribute [Authorize]
@inject HttpClient Http
@inject JwtAuthenticationStateProvider AuthProvider
@inject IJSRuntime JSRuntime
@inject ILogger<ChangePassword> Logger
@inject NavigationManager Navigation

<div class="container-xxl">
    <div class="authentication-wrapper authentication-basic container-p-y">
        <div class="authentication-inner py-6">
            <div class="card">
                <div class="card-body">
                    <div class="app-brand justify-content-center mb-6">
                        <a href="/" class="app-brand-link gap-2">
                            <span class="app-brand-logo demo">
                                <span class="text-primary">
                                    <svg width="32" height="22" viewBox="0 0 32 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M0.00172773 0V6.85398C0.00172773 6.85398 -0.133178 9.01207 1.98092 10.8388L13.6912 21.9964L19.7809 21.9181L18.8042 9.88248L16.4951 7.17289L9.23799 0H0.00172773Z" fill="currentColor"></path>
                                        <path opacity="0.06" fill-rule="evenodd" clip-rule="evenodd" d="M7.69824 16.4364L12.5199 3.23696L16.5541 7.25596L7.69824 16.4364Z" fill="#161616"></path>
                                        <path opacity="0.06" fill-rule="evenodd" clip-rule="evenodd" d="M8.07751 15.9175L13.9419 4.63989L16.5849 7.28475L8.07751 15.9175Z" fill="#161616"></path>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.77295 16.3566L23.6563 0H32V6.88383C32 6.88383 31.8262 9.17836 30.6591 10.4057L19.7824 22H13.6938L7.77295 16.3566Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                            </span>
                            <span class="app-brand-text demo text-heading fw-bold">Vuexy</span>
                        </a>
                    </div>

                    <h4 class="mb-1">Change Password </h4>
                    <p class="mb-6">Update your password to keep your account secure</p>

                    <EditForm Model="model" OnValidSubmit="HandleSubmit" id="formChangePassword">
                        <DataAnnotationsValidator />

                        <div class="mb-6 form-password-toggle">
                            <label class="form-label" for="currentPassword">Current Password</label>
                            <div class="input-group input-group-merge">
                                <InputText type="@(showCurrentPassword ? "text" : "password")"
                                           @bind-Value="model.CurrentPassword"
                                           class="form-control"
                                           id="currentPassword"
                                           placeholder="路路路路路路路路路路路路" />
                                <span class="input-group-text cursor-pointer" @onclick="() => showCurrentPassword = !showCurrentPassword">
                                    <i class="ti @(showCurrentPassword ? "tabler-eye" : "tabler-eye-off")"></i>
                                </span>
                            </div>
                            <ValidationMessage For="@(() => model.CurrentPassword)" class="text-danger" />
                        </div>

                        <div class="mb-6 form-password-toggle">
                            <label class="form-label" for="newPassword">New Password</label>
                            <div class="input-group input-group-merge">
                                <InputText type="@(showNewPassword ? "text" : "password")"
                                           @bind-Value="model.NewPassword"
                                           class="form-control"
                                           id="newPassword"
                                           placeholder="路路路路路路路路路路路路" />
                                <span class="input-group-text cursor-pointer" @onclick="() => showNewPassword = !showNewPassword">
                                    <i class="ti @(showNewPassword ? "tabler-eye" : "tabler-eye-off")"></i>
                                </span>
                            </div>
                            <ValidationMessage For="@(() => model.NewPassword)" class="text-danger" />
                        </div>

                        <div class="mb-6 form-password-toggle">
                            <label class="form-label" for="confirmPassword">Confirm New Password</label>
                            <div class="input-group input-group-merge">
                                <InputText type="@(showConfirmPassword ? "text" : "password")"
                                           @bind-Value="model.ConfirmNewPassword"
                                           class="form-control"
                                           id="confirmPassword"
                                           placeholder="路路路路路路路路路路路路" />
                                <span class="input-group-text cursor-pointer" @onclick="() => showConfirmPassword = !showConfirmPassword">
                                    <i class="ti @(showConfirmPassword ? "tabler-eye" : "tabler-eye-off")"></i>
                                </span>
                            </div>
                            <ValidationMessage For="@(() => model.ConfirmNewPassword)" class="text-danger" />
                        </div>

                        <button class="btn btn-primary d-grid w-100 mb-6" type="submit" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Changing Password...</span>
                            }
                            else
                            {
                                <span>Change Password</span>
                            }
                        </button>

                        <div class="text-center">
                            <a href="/" class="d-flex align-items-center justify-content-center">
                                <i class="ti tabler-chevron-left scaleX-n1-rtl me-2"></i>
                                Back to Dashboard
                            </a>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ChangePasswordModel model = new();
    private bool isLoading;
    private bool showCurrentPassword;
    private bool showNewPassword;
    private bool showConfirmPassword;

    private class ChangePasswordModel
    {
        [Required(ErrorMessage = "Current password is required")]
        public string CurrentPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "New password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "Please confirm your new password")]
        [Compare(nameof(NewPassword), ErrorMessage = "Passwords do not match")]
        public string ConfirmNewPassword { get; set; } = string.Empty;
    }

    private async Task HandleSubmit()
    {
        isLoading = true;

        var token = await AuthProvider.GetTokenAsync();
        if (!string.IsNullOrEmpty(token))
        {
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
        }

        try
        {
            var response = await Http.PostAsJsonAsync("/auth/change-password", model);
            
            if (response.IsSuccessStatusCode)
            {
                await JSRuntime.InvokeVoidAsync("showToast", "success", "Password changed successfully!");
                model = new ChangePasswordModel();
                
                await Task.Delay(1000);
                Navigation.NavigateTo("/");
            }
            else
            {
                var apiResponse = await response.Content.ReadFromJsonAsync<ApiResponse<object>>();
                var errorMessage = apiResponse?.Message ?? "Failed to change password";
                
                if (apiResponse?.Errors?.Count > 0)
                {
                    errorMessage = string.Join(", ", apiResponse.Errors);
                }
                
                await JSRuntime.InvokeVoidAsync("showToast", "error", errorMessage);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing password");
            await JSRuntime.InvokeVoidAsync("showToast", "error", "An error occurred. Please try again.");
        }
        finally
        {
            isLoading = false;
        }
    }
}
